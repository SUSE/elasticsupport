#!/usr/bin/env ruby
#
# Import a supportconfig into elasticsearch
#
# Index    (Database) Elasticsupport
# Type     (Table)    rpm
# Id
# Document (Row)      package name
# Field    (Column)   nevra

require 'rubygems'
require 'rubygems/package' # TarReader
require 'bzip2/bzip2'
require 'elasticsupport'

def usage(msg=nil)
  STDERR.puts "*** Err: #{msg}" if msg
  STDERR.puts "Usage:"
  STDERR.puts "elasticsupport <dir>|<tarball> [<file> [<file> ...]]"
  STDERR.puts "\t<dir> => unpacked supportconfig tarball"
  STDERR.puts "\t<tarball> => (compressed) supportconfig tarball"
  STDERR.puts ""
  STDERR.puts "\t<file> => file to parse from supportconfig"
  exit 1
end

#
# parse_supportconfig from directory (unpacked) or TarReader (tbz stream)
#

def parse_supportconfig handle, files
#  puts "parse_supportconfig #{files.inspect}"
  default_files = [ "basic-environment.txt"]#, "rpm.txt" ] # , "hardware.txt"
  if files.nil? || files.empty?
    files = default_files
  end
#  puts "Supportconfig: #{handle}"
  elasticsupport = Elasticsupport::Elasticsupport.new handle
  elasticsupport.index files
end

def parse_tarball file, files
  # assume tarball
#  puts "Assume #{file} is a tarball"
  begin
    uncompressed = Gem::Package::TarReader.new(Zlib::GzipReader.open(file))
  rescue Zlib::GzipFile::Error
    uncompressed = Gem::Package::TarReader.new(Bzip2::Reader.open(file))
  rescue
    STDERR.puts "#{file} is not a tarball"
    raise
  end
  parse_supportconfig uncompressed, files
end

def parse_argument arg, files
#  puts "parse_argument #{files.inspect}"
  # try <dir>/supportconfig.txt
  if File.readable?(File.join(arg, "supportconfig.txt"))
    # assume unpackage supportconfig
    parse_supportconfig arg, files
  elsif File.directory?(arg)
    # look inside dir
    Dir.open(arg).each do |f|
      next if f[0,1] == "."
      parse_argument File.join(arg, f), files
    end
  elsif File.readable?(arg)
    parse_tarball arg, files
  else
    STDERR.puts "'#{arg}' is neither a directory nor a tarball"
  end
end

arg = ARGV.shift

usage "<arg> parameter missing" unless arg

parse_argument arg, ARGV
