#encoding: utf-8
#
# logstash.rb
#
# Logstash connector for 'elasticsupport' library
#
# Copyright (c) 2016 SUSE LINUX GmbH
# Written by Klaus KÃ¤mpf <kkaempf@suse.de>
#
# See MIT-LICENSE at toplevel for license information
#

require 'rubygems'
require 'logger'

module Elasticsupport
  
  class Logstash

    attr_reader :job

    # initialize with name of the supportconfig
    def initialize elastic, name
      @elastic = elastic
      @name = name.downcase
      @dirname = File.dirname(__FILE__)
      @logstashdir = File.expand_path(File.join(@dirname, "..", "..", "logstash"))
      create_output
    end

    def run handle, files = []
      Dir.chdir @logstashdir do
        @job = spawn "/usr/share/logstash/bin/logstash", "--path.settings", @logstashdir,
                 :out => [ "logstash.out", "w" ], :err => [ "logstash.err", "w" ]
      end
    end

    private

    #
    # create_output
    # creates output.conf, pointing to correct index
    #
    def create_output
      # create logstash configs
      indexname = @name
      File.open(File.join(@logstashdir, "output.conf"), "w") do |f|
        f.write <<OUTPUT
# Generated by elasticsupport
output {
  elasticsearch {
    template => "elasticsupport-template.json"
    template_overwrite => true
    hosts => ["#{@elastic}"]
    index => #{indexname.inspect}
  }
}
OUTPUT
      end
    end

  end # class

end # module
